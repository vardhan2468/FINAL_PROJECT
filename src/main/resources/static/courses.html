<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses - LMS</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1>LMS - Learning Management System</h1>
            <div class="nav-right">
                <span id="user-info" class="user-info"></span>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="content-container">
            <h2>Available Courses</h2>
            
            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>
            
            <!-- Add Course Form (ADMIN only) -->
            <div id="add-course-form" style="display: none;">
                <div class="form-container" style="max-width: 600px; margin: 0 0 30px 0;">
                    <h3>Add New Course</h3>
                    <form id="course-form" onsubmit="addCourse(event)">
                        <div class="form-group">
                            <label for="course-title">Course Title</label>
                            <input type="text" id="course-title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="course-description">Description</label>
                            <textarea id="course-description" name="description" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="instructor-name">Instructor Name</label>
                            <input type="text" id="instructor-name" name="instructorName" required>
                        </div>
                        <div class="form-group">
                            <label for="photo-url">Course Photo URL</label>
                            <input type="url" id="photo-url" name="photoUrl" placeholder="https://example.com/image.jpg">
                            <small style="color: #666; font-size: 12px;">Enter a valid image URL or leave blank for default</small>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Course</button>
                    </form>
                </div>
            </div>
            
            <!-- Courses List -->
            <div id="courses-list" class="courses-grid">
                <p class="loading">Loading courses...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Immediately check authentication before page loads
        (function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
        })();
        
        let userRole = '';
        let currentUserId = null;
        
        // Validate token by making an API call
        async function validateToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                redirectToLogin();
                return false;
            }
            
            try {
                const response = await fetch('http://localhost:8080/api/courses/all', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401 || response.status === 403) {
                    // Token is invalid or expired
                    redirectToLogin();
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Token validation error:', error);
                return false;
            }
        }
        
        // Redirect to login and clear storage
        function redirectToLogin() {
            localStorage.removeItem('token');
            localStorage.removeItem('email');
            localStorage.removeItem('role');
            window.location.href = 'index.html';
        }
        
        // Check authentication and load data
        window.addEventListener('DOMContentLoaded', async () => {
            // Validate token first
            const isValid = await validateToken();
            if (!isValid) {
                return;
            }
            
            const email = localStorage.getItem('email');
            userRole = localStorage.getItem('role');
            
            if (email && userRole) {
                document.getElementById('user-info').textContent = `${email} (${userRole})`;
            }
            
            // Show add course form only for ADMIN
            if (userRole === 'ADMIN') {
                document.getElementById('add-course-form').style.display = 'block';
            }
            
            loadCourses();
        });
        
        // Fetch all courses from API
        async function loadCourses() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('http://localhost:8080/api/courses/all', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const courses = await response.json();
                    displayCourses(courses);
                } else if (response.status === 401 || response.status === 403) {
                    // Token expired or invalid
                    redirectToLogin();
                } else {
                    showError('Failed to load courses');
                }
            } catch (error) {
                console.error('Error loading courses:', error);
                showError('Failed to connect to server');
            }
        }
        
        // Display courses as cards
        function displayCourses(courses) {
            const coursesList = document.getElementById('courses-list');
            
            if (courses.length === 0) {
                coursesList.innerHTML = '<p class="loading">No courses available</p>';
                return;
            }
            
            coursesList.innerHTML = courses.map(course => `
                <div class="course-card">
                    <div class="course-image">
                        <img src="${course.photoUrl || 'https://via.placeholder.com/400x250?text=Course+Image'}" 
                             alt="${course.title}" 
                             onerror="this.src='https://via.placeholder.com/400x250?text=Image+Not+Found'">
                    </div>
                    <div class="course-content">
                        <h3>${course.title}</h3>
                        <p>${course.description}</p>
                        <p class="instructor">Instructor: ${course.instructorName}</p>
                        ${userRole === 'STUDENT' ? 
                            `<button onclick="enrollInCourse(${course.id})" class="btn btn-success">Enroll</button>` 
                            : ''}
                        ${userRole === 'ADMIN' ? 
                            `<div class="admin-actions">
                                <button onclick="editCourse(${course.id})" class="btn btn-secondary">Edit</button>
                                <button onclick="deleteCourse(${course.id})" class="btn btn-danger">Delete</button>
                            </div>` 
                            : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Add new course (ADMIN only)
        async function addCourse(event) {
            event.preventDefault();
            const token = localStorage.getItem('token');
            
            const photoUrl = document.getElementById('photo-url').value.trim();
            const formData = {
                title: document.getElementById('course-title').value,
                description: document.getElementById('course-description').value,
                instructorName: document.getElementById('instructor-name').value,
                photoUrl: photoUrl || 'https://via.placeholder.com/400x250?text=Course+Image'
            };
            
            try {
                const response = await fetch('http://localhost:8080/api/courses/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('Course added successfully!');
                    document.getElementById('course-form').reset();
                    loadCourses(); // Reload courses list
                } else if (response.status === 401 || response.status === 403) {
                    showError('You do not have permission to add courses');
                    if (response.status === 401) {
                        redirectToLogin();
                    }
                } else {
                    showError('Failed to add course');
                }
            } catch (error) {
                console.error('Error adding course:', error);
                showError('Failed to connect to server');
            }
        }
        
        // Delete course (ADMIN only)
        async function deleteCourse(courseId) {
            if (!confirm('Are you sure you want to delete this course?')) {
                return;
            }
            
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`http://localhost:8080/api/courses/${courseId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok || response.status === 204) {
                    showSuccess('Course deleted successfully!');
                    loadCourses(); // Reload courses list
                } else if (response.status === 404) {
                    showError('Course not found');
                } else if (response.status === 401 || response.status === 403) {
                    showError('You do not have permission to delete courses');
                    if (response.status === 401) {
                        redirectToLogin();
                    }
                } else {
                    showError('Failed to delete course');
                }
            } catch (error) {
                console.error('Error deleting course:', error);
                showError('Failed to connect to server');
            }
        }
        
        // Edit course (ADMIN only)
        async function editCourse(courseId) {
            const token = localStorage.getItem('token');
            
            try {
                // First, get the course details
                const response = await fetch(`http://localhost:8080/api/courses/${courseId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const course = await response.json();
                    
                    // Populate form with existing data
                    document.getElementById('course-title').value = course.title;
                    document.getElementById('course-description').value = course.description;
                    document.getElementById('instructor-name').value = course.instructorName;
                    document.getElementById('photo-url').value = course.photoUrl || '';
                    
                    // Change form to update mode
                    const form = document.getElementById('course-form');
                    form.onsubmit = (e) => updateCourse(e, courseId);
                    
                    // Update button text
                    const submitBtn = form.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'Update Course';
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-warning');
                    
                    // Add cancel button
                    if (!document.getElementById('cancel-edit-btn')) {
                        const cancelBtn = document.createElement('button');
                        cancelBtn.id = 'cancel-edit-btn';
                        cancelBtn.type = 'button';
                        cancelBtn.className = 'btn btn-secondary';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.style.marginLeft = '10px';
                        cancelBtn.onclick = cancelEdit;
                        submitBtn.parentNode.appendChild(cancelBtn);
                    }
                    
                    // Scroll to form
                    document.getElementById('add-course-form').scrollIntoView({ behavior: 'smooth' });
                } else if (response.status === 401 || response.status === 403) {
                    redirectToLogin();
                } else {
                    showError('Failed to load course details');
                }
            } catch (error) {
                console.error('Error loading course:', error);
                showError('Failed to connect to server');
            }
        }
        
        // Update course (ADMIN only)
        async function updateCourse(event, courseId) {
            event.preventDefault();
            const token = localStorage.getItem('token');
            
            const photoUrl = document.getElementById('photo-url').value.trim();
            const formData = {
                title: document.getElementById('course-title').value,
                description: document.getElementById('course-description').value,
                instructorName: document.getElementById('instructor-name').value,
                photoUrl: photoUrl || 'https://via.placeholder.com/400x250?text=Course+Image'
            };
            
            try {
                const response = await fetch(`http://localhost:8080/api/courses/${courseId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showSuccess('Course updated successfully!');
                    cancelEdit();
                    loadCourses(); // Reload courses list
                } else if (response.status === 404) {
                    showError('Course not found');
                } else if (response.status === 401 || response.status === 403) {
                    showError('You do not have permission to update courses');
                    if (response.status === 401) {
                        redirectToLogin();
                    }
                } else {
                    showError('Failed to update course');
                }
            } catch (error) {
                console.error('Error updating course:', error);
                showError('Failed to connect to server');
            }
        }
        
        // Cancel edit mode
        function cancelEdit() {
            const form = document.getElementById('course-form');
            form.reset();
            form.onsubmit = addCourse;
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Add Course';
            submitBtn.classList.remove('btn-warning');
            submitBtn.classList.add('btn-primary');
            
            const cancelBtn = document.getElementById('cancel-edit-btn');
            if (cancelBtn) {
                cancelBtn.remove();
            }
        }
        
        // Enroll in course (STUDENT only)
        async function enrollInCourse(courseId) {
            const token = localStorage.getItem('token');
            const email = localStorage.getItem('email');
            
            try {
                // First, get user ID
                if (!currentUserId) {
                    const userResponse = await fetch('http://localhost:8080/api/users/all', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (userResponse.ok) {
                        const users = await userResponse.json();
                        const user = users.find(u => u.email === email);
                        if (user) {
                            currentUserId = user.id;
                        }
                    } else if (userResponse.status === 401 || userResponse.status === 403) {
                        redirectToLogin();
                        return;
                    }
                }
                
                if (!currentUserId) {
                    showError('User not found');
                    return;
                }
                
                // Enroll in course
                const enrollResponse = await fetch('http://localhost:8080/api/enrollments/enroll', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId: currentUserId,
                        courseId: courseId
                    })
                });
                
                if (enrollResponse.ok) {
                    showSuccess('Successfully enrolled in course!');
                } else if (enrollResponse.status === 409) {
                    showError('You are already enrolled in this course');
                } else if (enrollResponse.status === 401 || enrollResponse.status === 403) {
                    // Token expired or no permission
                    if (enrollResponse.status === 401) {
                        redirectToLogin();
                    } else {
                        showError('You do not have permission to enroll');
                    }
                } else {
                    showError('Failed to enroll in course');
                }
            } catch (error) {
                console.error('Error enrolling:', error);
                showError('Failed to connect to server');
            }
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('email');
            localStorage.removeItem('role');
            window.location.href = 'index.html';
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            const successDiv = document.getElementById('success-message');
            successDiv.style.display = 'none';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'none';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>